<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AegisIQ Stock Ledger</title>
  <meta name="description" content="Enterprise stock ledger management system with role-based access control" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- App Styles -->
  <link rel="stylesheet" href="app.css">
</head>
<body class="theme-dark">

<!-- ================= HEADER ================= -->
<header class="header navy-bg">
  <nav class="nav-container">
    <div class="nav-content">
      <img src="logo.svg" alt="AegisIQ Stock Ledger" class="logo-img" />

      <!-- Desktop Navigation -->
      <div class="nav-links">
        <a href="#" class="nav-link active" data-page="ledger">Ledger</a>
        <a href="#" class="nav-link" data-page="reports">Reports</a>
        <a href="#" class="nav-link" data-page="audit">Audit</a>
        <!-- Admin-only Button -->
        <button id="adminButton" class="btn btn-gold hidden">Admin Panel</button>
      </div>

      <!-- User Dropdown -->
      <div class="user-dropdown" id="userDropdown">
        <button class="user-trigger" id="userTrigger">
          <div class="user-avatar" id="userAvatar">--</div>
          <span class="user-name" id="userName">Loading...</span>
          <svg class="chevron" width="14" height="14" viewBox="0 0 24 24">
            <polyline points="6 9 12 15 18 9" fill="none" stroke="currentColor" stroke-width="2"/>
          </svg>
        </button>
        <div class="user-menu" id="userMenu">
          <div class="user-menu-header">
            <span class="user-menu-email" id="userEmail"></span>
            <span class="user-menu-role" id="userRole"></span>
          </div>
          <div class="user-menu-divider"></div>
          <button class="user-menu-item danger" onclick="logout()">Log out</button>
        </div>
      </div>

      <!-- Mobile Menu Toggle -->
      <button class="mobile-menu-toggle" id="mobileMenuToggle">
        <svg class="menu-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="3" y1="12" x2="21" y2="12"></line>
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      </button>
    </div>

    <!-- Mobile Menu -->
    <div class="mobile-menu hidden" id="mobileMenu">
      <a href="#" class="mobile-nav-link" data-page="ledger">Ledger</a>
      <a href="#" class="mobile-nav-link" data-page="reports">Reports</a>
      <a href="#" class="mobile-nav-link" data-page="audit">Audit</a>
      <div class="mobile-auth">
        <button class="btn btn-outline full-width" onclick="logout()">Logout</button>
      </div>
    </div>
  </nav>
</header>

<!-- ================= MAIN APP ================= -->
<main>
  <section class="section-container">
    <div class="app-shell">

      <!-- Page Header -->
      <div class="page-header">
        <div class="page-header-text">
          <h1 class="app-title gold-text" id="entityName">Loading...</h1>
          <p class="app-subtitle" id="entityDetails">
            <span><strong>Entity ID:</strong> <span id="entityId"></span></span><br>
            <span><strong>Address:</strong> <span id="entityAddress"></span></span><br>
            <span><strong>Email:</strong> <span id="entityEmail"></span></span><br>
            <span><strong>Tel:</strong> <span id="entityPhone"></span></span>
          </p>
        </div>
        <div class="page-header-stats">
          <div class="stat-badge">
            <span class="stat-label">Total Shareholders</span>
            <span class="stat-value" id="totalShareholdersCount">0</span>
          </div>
          <div class="stat-badge">
            <span class="stat-label">Total Shares</span>
            <span class="stat-value" id="totalSharesCount">0</span>
          </div>
        </div>
      </div>

      <!-- ================= FILTER BAR ================= -->
      <div class="filters-container card">
        <div class="filter-group">
          <input type="text" id="searchInput" placeholder="Search ID or name..." oninput="applyFilters()" />
          <select id="entityFilter" onchange="handleEntityChange()">
            <option value="">All Entities</option>
            <!-- Populated from DB - only visible to SUPER_ADMIN -->
          </select>
          <select id="stockTypeFilter" onchange="handleStockTypeChange()">
            <option value="">All Stock Types</option>
            <!-- Populated dynamically from entity_stock_types -->
          </select>
          <select id="seriesFilter" onchange="applyFilters()" disabled>
            <option value="">All Series</option>
            <!-- Populated dynamically from entity_stock_series -->
          </select>
          <select id="statusFilter" onchange="applyFilters()">
            <option value="">All Status</option>
            <option value="ACTIVE">Active</option>
            <option value="INACTIVE">Inactive</option>
          </select>
        </div>

        <div class="filter-actions">
          <button class="btn btn-ghost" onclick="resetFilters()">Reset</button>
          <button class="btn btn-primary" onclick="exportCSV()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            Export CSV
          </button>
          <button class="btn btn-gold" onclick="openCreateShareholderModal()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Add Shareholder
          </button>
        </div>
      </div>

      <!-- ================= HOLDINGS MATRIX (Dark Executive Grid) ================= -->
      <div class="card holdings-matrix">
        <!-- Header - rendered dynamically from stock types + series -->
        <div class="matrix-header" id="matrixHeader">
          <!-- Columns generated by JS -->
        </div>

        <!-- Body - shareholder rows with expandable detail panels -->
        <div class="matrix-body" id="holdingsMatrixBody">
          <div class="loading-state">
            <div class="spinner"></div>
            <span>Loading ownership data...</span>
          </div>
        </div>

        <!-- Footer - totals rendered dynamically -->
        <div class="matrix-footer" id="matrixFooter">
          <!-- Totals generated by JS -->
        </div>
      </div>

    </div>
  </section>
</main>

<!-- ================= FOOTER ================= -->
<footer class="footer navy-bg">
  <div class="footer-container">
    <span class="gold-text">Â© 2026 AegisIQ. All rights reserved.</span>
    <span class="separator">|</span>
    <a href="#">Terms of Service</a>
    <span class="separator">|</span>
    <a href="mailto:support@aegisiq.online">support@aegisiq.online</a>
    <button class="back-to-top" onclick="scrollToTop()">Back to Top</button>
  </div>
</footer>

<!-- ================= MODALS ================= -->
<!-- Create/Edit Shareholder Modal -->
<div class="modal-overlay hidden" id="shareholderModal">
  <div class="modal">
    <div class="modal-header">
      <h3 class="modal-title" id="modalTitle">Add Shareholder</h3>
      <button class="modal-close" onclick="closeShareholderModal()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <div class="modal-body">
      <form id="shareholderForm" onsubmit="handleShareholderSubmit(event)">
        <input type="hidden" id="formShareholderId" />
        <div class="form-row">
          <div class="form-group">
            <label for="formFullName">Full Name *</label>
            <input type="text" id="formFullName" required />
          </div>
          <div class="form-group">
            <label for="formExternalId">Account #</label>
            <input type="text" id="formExternalId" placeholder="Auto-generated if blank" />
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="formEmail">Email</label>
            <input type="email" id="formEmail" />
          </div>
          <div class="form-group">
            <label for="formPhone">Phone</label>
            <input type="text" id="formPhone" />
          </div>
        </div>
        <div class="form-group">
          <label for="formAddress">Address</label>
          <input type="text" id="formAddress" />
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="formCity">City</label>
            <input type="text" id="formCity" />
          </div>
          <div class="form-group">
            <label for="formState">State</label>
            <input type="text" id="formState" />
          </div>
          <div class="form-group">
            <label for="formZipCode">Zip Code</label>
            <input type="text" id="formZipCode" />
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="formShareholderType">Type</label>
            <select id="formShareholderType">
              <option value="INDIVIDUAL">Individual</option>
              <option value="INSTITUTION">Institution</option>
              <option value="TRUST">Trust</option>
              <option value="ESTATE">Estate</option>
            </select>
          </div>
          <div class="form-group">
            <label for="formTaxId">Tax ID</label>
            <input type="text" id="formTaxId" />
          </div>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-ghost" onclick="closeShareholderModal()">Cancel</button>
          <button type="submit" class="btn btn-gold">Save Shareholder</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<!-- App Script - handles all dynamic behavior -->
<script src="app.js"></script>
</body>
</html>
