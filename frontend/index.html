<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Preferred Stock Ledger Manager</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    * { font-family: 'Inter', sans-serif; }
    .hidden { display: none; }
    .toast{position:fixed;top:20px;right:20px;padding:14px 18px;border-radius:10px;color:#fff;font-weight:600;z-index:9999;transform:translateX(120%);transition:.25s;max-width:420px}
    .toast.show{transform:translateX(0)}
    .toast.success{background:#16a34a}
    .toast.error{background:#dc2626}
    .toast.info{background:#2563eb}
    .btn-loader{display:inline-block;width:18px;height:18px;border:2px solid rgba(255,255,255,.35);border-radius:50%;border-top-color:#fff;animation:spin 1s linear infinite}
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>

<body class="bg-gray-50 min-h-screen">
  <div id="toast-container"></div>

  <script>
    const API_CONFIG = {
      BASE_URL: '/api',
      ENDPOINTS: { AUTH: '/auth' }
    };

    function showToast(message, type='info', duration=3000){
      const c=document.getElementById('toast-container');
      const t=document.createElement('div');
      t.className=`toast ${type}`;
      t.textContent=message;
      c.appendChild(t);
      setTimeout(()=>t.classList.add('show'),10);
      setTimeout(()=>{t.classList.remove('show');setTimeout(()=>c.removeChild(t),250)},duration);
    }

    function setButtonLoading(buttonId, isLoading){
      const btn=document.getElementById(buttonId);
      const loader=document.getElementById(`${buttonId}-loader`);
      if(btn) btn.disabled=isLoading;
      if(loader) loader.classList.toggle('hidden', !isLoading);
    }

    async function apiRequest(action, payload = null) {
      const token = localStorage.getItem('token');
      const url = `${API_CONFIG.BASE_URL}${API_CONFIG.ENDPOINTS.AUTH}?action=${encodeURIComponent(action)}`;

      const res = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type':'application/json',
          ...(token ? { 'Authorization': `Bearer ${token}` } : {})
        },
        body: payload ? JSON.stringify(payload) : JSON.stringify({})
      });

      const ct = res.headers.get('content-type') || '';
      const data = ct.includes('application/json') ? await res.json() : { success:false, error: await res.text() };

      if (!res.ok || data.success === false) {
        throw new Error(data.error || data.message || `Request failed (${res.status})`);
      }
      return data;
    }

    function showLoginPage(){
      document.getElementById('login-page').classList.remove('hidden');
      document.getElementById('register-page').classList.add('hidden');
    }
    function showRegisterPage(){
      document.getElementById('register-page').classList.remove('hidden');
      document.getElementById('login-page').classList.add('hidden');
    }

    async function handleLogin(e){
      e.preventDefault();
      setButtonLoading('login-btn', true);
      try {
        const email=document.getElementById('login-email').value;
        const password=document.getElementById('login-password').value;

        const data = await apiRequest('login', { email, password });
        localStorage.setItem('token', data.token);
        localStorage.setItem('user', JSON.stringify(data.user));

        showToast('Login successful', 'success');
        document.getElementById('auth-container').classList.add('hidden');
        document.getElementById('app-container').classList.remove('hidden');
        document.getElementById('username').textContent = data.user.full_name || data.user.email || '';
      } catch (err) {
        showToast(err.message, 'error');
      } finally {
        setButtonLoading('login-btn', false);
      }
    }

    async function handleRegister(e){
      e.preventDefault();
      setButtonLoading('register-btn', true);
      try {
        const full_name=document.getElementById('register-name').value;
        const email=document.getElementById('register-email').value;
        const password=document.getElementById('register-password').value;

        const data = await apiRequest('register', { full_name, email, password });

        // auto-login if token returned
        if (data.token) {
          localStorage.setItem('token', data.token);
          localStorage.setItem('user', JSON.stringify(data.user));
          showToast('Registered + logged in!', 'success');
          document.getElementById('auth-container').classList.add('hidden');
          document.getElementById('app-container').classList.remove('hidden');
          document.getElementById('username').textContent = data.user.full_name || data.user.email || '';
        } else {
          showToast('Registration successful. Please login.', 'success');
          showLoginPage();
        }
      } catch (err) {
        showToast(err.message, 'error');
      } finally {
        setButtonLoading('register-btn', false);
      }
    }

    async function logout(){
      setButtonLoading('logout-btn', true);
      try {
        await apiRequest('logout', {});
      } catch(_) {
        // even if API fails, still clear local session
      } finally {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        document.getElementById('app-container').classList.add('hidden');
        document.getElementById('auth-container').classList.remove('hidden');
        showToast('Logged out', 'info');
        setButtonLoading('logout-btn', false);
      }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      const token = localStorage.getItem('token');
      const user = localStorage.getItem('user');
      if (token && user) {
        const u = JSON.parse(user);
        document.getElementById('auth-container').classList.add('hidden');
        document.getElementById('app-container').classList.remove('hidden');
        document.getElementById('username').textContent = u.full_name || u.email || '';
      }
    });
  </script>

  <!-- AUTH -->
  <div id="auth-container" class="min-h-screen flex items-center justify-center p-4">
    <div class="max-w-md w-full">
      <div class="text-center mb-6">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">ðŸ“Š Preferred Stock Ledger</h1>
        <p class="text-gray-600">Login / Register</p>
      </div>

      <div id="login-page" class="bg-white rounded-2xl shadow p-6">
        <h2 class="text-xl font-bold mb-4">Login</h2>
        <form onsubmit="handleLogin(event)" class="space-y-4">
          <input id="login-email" type="email" required placeholder="Email"
            class="w-full p-3 border rounded-lg" />
          <input id="login-password" type="password" required placeholder="Password"
            class="w-full p-3 border rounded-lg" />

          <button id="login-btn" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold">
            Login <span id="login-btn-loader" class="btn-loader ml-2 hidden"></span>
          </button>
        </form>
        <div class="mt-4 text-center">
          <button type="button" onclick="showRegisterPage()" class="text-blue-600 font-semibold">Create account</button>
        </div>
      </div>

      <div id="register-page" class="bg-white rounded-2xl shadow p-6 hidden">
        <h2 class="text-xl font-bold mb-4">Register</h2>
        <form onsubmit="handleRegister(event)" class="space-y-4">
          <input id="register-name" type="text" required placeholder="Full name"
            class="w-full p-3 border rounded-lg" />
          <input id="register-email" type="email" required placeholder="Email"
            class="w-full p-3 border rounded-lg" />
          <input id="register-password" type="password" required placeholder="Password"
            class="w-full p-3 border rounded-lg" />

          <button id="register-btn" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold">
            Register <span id="register-btn-loader" class="btn-loader ml-2 hidden"></span>
          </button>
        </form>
        <div class="mt-4 text-center">
          <button type="button" onclick="showLoginPage()" class="text-blue-600 font-semibold">Back to login</button>
        </div>
      </div>
    </div>
  </div>

  <!-- APP -->
  <div id="app-container" class="hidden">
    <nav class="bg-white shadow px-6 py-4 flex justify-between items-center">
      <div class="font-bold text-xl">ðŸ“Š Preferred Stock Ledger</div>
      <div class="flex items-center gap-4">
        <span id="username" class="font-semibold text-gray-700"></span>
        <button id="logout-btn" onclick="logout()" class="bg-red-600 text-white px-4 py-2 rounded-lg font-semibold">
          Logout <span id="logout-btn-loader" class="btn-loader ml-2 hidden"></span>
        </button>
      </div>
    </nav>

    <div class="p-6">
      <p class="text-gray-700">Auth is working. Next: connect ledger UI.</p>
    </div>
  </div>
</body>
</html>
